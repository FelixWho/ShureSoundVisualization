<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Waveform</title>
</head>
<body>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="../three.min.js"></script>
<script src="../jquery-3.4.1.min.js"></script>
<script>
function startListening() {
    navigator.mediaDevices.getUserMedia({audio: true, video: false}).then(stream => {
        const context = new AudioContext();
        const source = context.createMediaStreamSource(stream);

        // server side
        var sessionID = "" + Date.now();
        var postUrl = "";

        function urlInit() {
            const req = new XMLHttpRequest();
            req.open("POST", "http://35.193.212.185/api/init", true);
            req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            req.send(JSON.stringify({rate: context.sampleRate, sessionID: sessionID, location: ""}));

            req.addEventListener("load", urlCallback, false);
        }

        function urlCallback(event) {

            let data = JSON.parse(event.target.responseText);
            console.log(data);
            console.log("success", data.success);

            postUrl = data.url;
        }

        urlInit();



        const processor = context.createScriptProcessor(4096, 1, 1);

        source.connect(processor);

        const fakeDestination = context.createMediaStreamDestination();

        processor.connect(fakeDestination);

        let index = 0;
        processor.onaudioprocess = event => {
            // console.log(event);

            let data = event.inputBuffer.getChannelData(0);
            // console.log(data);

            let dataString = "[" + data.join(",") + "]";

            const packet = {"data" : dataString, "index" : index++};
            //console.log("packet: "+JSON.stringify(packet));
            /*
            const xmlHttp = new XMLHttpRequest();
            xmlHttp.open("POST", "http://35.193.212.185" + postUrl, true);
            xmlHttp.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            xmlHttp.send(JSON.stringify(packet));

            xmlHttp.addEventListener("load", callback, false);
            */
        };

        function callback(d) {
            console.log(d);
        }

        const analyzer = context.createAnalyser();

        analyzer.fftSize = 512;
        analyzer.minDecibels = -100;
        analyzer.maxDecibels = -10;
        analyzer.smoothingTimeConstant = 0.40;

        source.connect(analyzer);
        analyzer.connect(fakeDestination);


    let isListener = false;
    let camera, scene, renderer;
    let geometry, material, mesh;

    function init() {

        camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.01, 10 );
        camera.position.z = 2;

        scene = new THREE.Scene();
        material = new THREE.MeshNormalMaterial();

        geometry1 = new THREE.CubeGeometry( 0.07, 0.07, 0.07);
        geometry2 = new THREE.CubeGeometry( 0.07, 0.07, 0.07 );
        geometry3 = new THREE.CubeGeometry( 0.07,0.07, 0.07 );

        mesh1 = new THREE.Mesh( geometry1, material );
        mesh2 = new THREE.Mesh( geometry2, material );
        mesh3 = new THREE.Mesh( geometry3, material );

        scene.add( mesh1 );
        scene.add( mesh2 );
        scene.add( mesh3 );

        mesh1.position.set(-0.5, 0, 0);
        mesh2.position.set(0,0,0);
        mesh3.position.set(0.5,0,0);

        renderer = new THREE.WebGLRenderer( {antialias: true, alias: true} );
        renderer.setSize( window.innerWidth, window.innerHeight );

        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        //renderer.setClearColor (0xdfe6e9, 1);
        document.body.appendChild(renderer.domElement);

    }

    init();

    function refreshBins(){
        let buf = new Float32Array(analyzer.frequencyBinCount);
        analyzer.getFloatFrequencyData(buf);
        /**** FELIX EDIT *****/
        const totalBin = analyzer.frequencyBinCount-1;
        let data = new Float64Array(analyzer.frequencyBinCount);
        let sum = new Float64Array(data.length);
        let sum_sq = new Float64Array(data.length);
        sum[0] = buf[0];
        sum_sq[0] = Math.pow(buf[0], 2);
        for(let i = 1; i < buf.length-36; i++){
            sum[i] = buf[i]+sum[i-1];
            sum_sq[i] = Math.pow(buf[i], 2)+sum_sq[i-1];
            if(i == buf.length-1){
                currAvgDB = 1.0*sum[buf.length-1]/buf.length;
            }
        }
        // two pointer
        for(let i = 0; i < buf.length-36; i++){
            for(let j = i+1; j < buf.length-36; j++){
                let var1 = (sum_sq[i])/i - Math.pow(sum[i]/i, 2);
                let var2 = (sum_sq[j]-sum_sq[i])/(j-i) - Math.pow((sum[j]-sum[i])/(j-i), 2);
                let var3 = (sum_sq[totalBin]-sum_sq[j])/(totalBin-j) - Math.pow((sum[totalBin]-sum[j])/(totalBin-j), 2);
                if(Math.abs(var1-var2) <= 2 && Math.abs(var2-var3) <= 2){
                    if(Math.abs(arr[1]-i) > 15){
                        if(arr[1] > i) {
                            arr[1] -= 15;
                        } else {
                            arr[1] += 15;
                        }
                    } else {
                        arr[1] = i;
                    }
                    if(Math.abs(arr[2]-j) > 15){
                        if(arr[2] > j) {
                            arr[2] -= 15;
                        } else {
                            arr[2] += 15;
                        }
                    } else {
                        arr[2] = j;
                    }
                    //arr[1] = i; arr[2] = j;
                    //console.log(var1, var2, var3);
                    console.log(0, arr[1], arr[2], arr[3]);
                    //console.log("Mean: ", sum[i]/i, (sum[j]-sum[i])/(j-i), (sum[totalBin]-sum[j])/(totalBin-j));
                    return;
                }
            }
        }

        //console.log(0,arr[1], arr[2], 255);
    }

    function animate() {
    
        let a = arr[0], b = arr[1], c = arr[2], d = arr[3];
        if(d < c){d = c;}
        let buf = new Float32Array(analyzer.frequencyBinCount);
        analyzer.getFloatFrequencyData(buf);

        const minFreq = 0;
        const maxFreq = context.sampleRate / 2;

        let sum1 = 0.0, sum2 = 0.0, sum3 = 0.0;
        for(let i = a; i < Math.min(buf.length, b); i++){
            sum1+=buf[i];
        }
        for(let i = b; i < Math.min(buf.length, c); i++){
            sum2+=buf[i];
        }
        for(let i = c; i < Math.min(buf.length, d); i++){
            sum3+=buf[i];
        }

        let avg1 = sum1 / ((Math.min(buf.length, b)-a)*1.0);
        let avg2 = sum2 / ((Math.min(buf.length, c)-b)*1.0);
        let avg3 = sum3 / ((Math.min(buf.length, d)-c)*1.0);

        avg1 = median(buf, a, b);
        avg2 = median(buf, b, c);
        avg3 = median(buf, c, d);

        function median(array, start, end) {
            temp = new Array(end-start);

            for(let i = 0; i < end-start; i++) {
                temp[i] = array[i + start];
            }

            temp = temp.sort((a, b) => (a - b));

            let middle = Math.floor(temp.length/2);
            if(temp.length % 2 === 0) {
                return (temp[middle]+temp[middle-1])/2;
            }
            else {
                return temp[middle];
            }
        }

        //console.log(avg3);
        //console.log(avg);

        // setInterval(analyze, 50);

        requestAnimationFrame( animate );

        mesh1.rotation.x += 0.005;
        mesh1.rotation.y += 0.005;
        mesh2.rotation.x -= 0.005;
        mesh2.rotation.y += 0.005;
        mesh3.rotation.x -= 0.005;
        mesh3.rotation.y -= 0.005;

        approx_min = -150;
        approx_max = -60;

        scaleish1 = 1.0*(Math.max(avg1 - approx_min,0))/(approx_max - approx_min);
        scaleish2 = 1.0*(Math.max(avg2 - approx_min,0))/(approx_max - approx_min);
        scaleish3 = 1.0*(Math.max(avg3 - approx_min,0))/(approx_max - approx_min);

        scale1 = 1 + 3.5*Math.max(Math.min(scaleish1, 1), 0);
        scale2 = 1 + 3.5*Math.max(Math.min(scaleish2, 1), 0);
        scale3 = 1 + 3.5*Math.max(Math.min(scaleish3, 1), 0);

        mesh1.scale.x = scale1;
        mesh1.scale.y = scale1;
        mesh1.scale.z = scale1;
        mesh2.scale.x = scale2;
        mesh2.scale.y = scale2;
        mesh2.scale.z = scale2;
        mesh3.scale.x = scale3;
        mesh3.scale.y = scale3;
        mesh3.scale.z = scale3;

        renderer.render( scene, camera );

    }

    function checkChangeColor(){

    }

    let arr =  [0, 45, 60, 219];
    let count = 0;
    const interval = setInterval(function() {
        refreshBins();
    }, 250);
    animate();
        
    });
}

    function listener(event){ // user chose listener role
        isListener = true;
        startListening();

        let back = document.createElement("INPUT");
        back.type = "submit"; back.value = "back";
        back.addEventListener("click", function(event){
            location.reload(false);
        })
        document.body.insertBefore(back, document.getElementById("listener"));

        if(document.getElementById("listener")){
            document.getElementById("listener").remove();
        }
        if(document.getElementById("player")){
            document.getElementById("player").remove();
        }
    }

    function player(event){ // user chose player role

        isListener = false;

        let back = document.createElement("INPUT");
        back.type = "submit"; back.value = "back";
        back.addEventListener("click", function(event){
            location.reload(false);
        })
        document.body.insertBefore(back, document.getElementById("listener"));
        
        if(document.getElementById("listener")){
            document.getElementById("listener").remove();
        }
        if(document.getElementById("player")){
            document.getElementById("player").remove();
        }
        
    }

</script>

<input type = "submit" id = "listener" value = "listener">
<input type = "submit" id = "player" value = "player">

<script>
    /* EVENT LISTENERS */
    document.getElementById("listener").addEventListener("click", listener, false);
    document.getElementById("player").addEventListener("click", player, false);
</script>

</body>
</html>